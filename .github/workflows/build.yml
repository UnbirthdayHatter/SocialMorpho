name: Build Social Morpho

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Download Dalamud
        shell: pwsh
        run: |
          $dalamudPath = "$env:AppData\XIVLauncher\addon\Hooks\14.0.2.1"
          New-Item -ItemType Directory -Force -Path $dalamudPath | Out-Null

          $url = "https://github.com/goatcorp/dalamud-distrib/raw/main/latest.zip"
          Invoke-WebRequest -Uri $url -OutFile "dalamud.zip"
          Expand-Archive -Force "dalamud.zip" $dalamudPath

          $dalamudDll = Join-Path $dalamudPath "Dalamud.dll"
          if (-not (Test-Path $dalamudDll)) {
            Write-Error "Dalamud.dll not found after download"
            exit 1
          }

      - name: Restore
        run: dotnet restore

      - name: Build Release
        run: dotnet build SocialMorpho.csproj -c Release --no-restore

      - name: Create latest.zip
        shell: pwsh
        run: |
          $outputDir = "bin/Release/net10.0-windows"
          $releaseDir = "release"
          Remove-Item -Recurse -Force $releaseDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $releaseDir | Out-Null

          $required = @(
            "$outputDir/SocialMorpho.dll",
            "$outputDir/SocialMorpho.json"
          )

          foreach ($file in $required) {
            if (-not (Test-Path $file)) {
              Write-Error "Missing required build output: $file"
              exit 1
            }
            Copy-Item $file -Destination $releaseDir
          }


          if (Test-Path "$outputDir/Quests.json") {
            Copy-Item "$outputDir/Quests.json" -Destination $releaseDir
          }

          Compress-Archive -Path "$releaseDir/*" -DestinationPath "latest.zip" -Force
          Get-ChildItem latest.zip | Format-List Name,Length

      - name: Validate latest.zip contents
        shell: pwsh
        run: |
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          $zipPath = (Resolve-Path "latest.zip").Path
          $zip = [System.IO.Compression.ZipFile]::OpenRead($zipPath)
          try {
            $entries = @($zip.Entries | ForEach-Object { $_.FullName })
            $required = @("SocialMorpho.dll", "SocialMorpho.json")

            foreach ($file in $required) {
              if ($entries -notcontains $file) {
                Write-Error "Invalid latest.zip: missing root entry '$file'. Entries: $($entries -join ', ')"
                exit 1
              }
            }

            if ($entries -contains "latest.zip") {
              Write-Error "Invalid latest.zip: found nested latest.zip entry."
              exit 1
            }
          } finally {
            $zip.Dispose()
          }

      - name: Upload latest.zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: latest-zip
          path: latest.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Download latest.zip artifact
        uses: actions/download-artifact@v4
        with:
          name: latest-zip
          path: .

      - name: Validate downloaded latest.zip
        shell: bash
        run: |
          unzip -l latest.zip
          unzip -Z1 latest.zip | grep -qx "SocialMorpho.dll"
          unzip -Z1 latest.zip | grep -qx "SocialMorpho.json"
          if unzip -Z1 latest.zip | grep -qx "latest.zip"; then
            echo "Invalid latest.zip: nested latest.zip found"
            exit 1
          fi

      - name: Publish or update latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          body: |
            Automated release from `${{ github.ref_name }}`.
            Commit: `${{ github.sha }}`
          files: latest.zip
          draft: false
          prerelease: true

