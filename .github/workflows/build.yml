name: Build Social Morpho

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Download Dalamud
        shell: pwsh
        run: |
          $dalamudPath = "$env:AppData\XIVLauncher\addon\Hooks\14.0.2.1"
          New-Item -ItemType Directory -Force -Path $dalamudPath | Out-Null

          $url = "https://github.com/goatcorp/dalamud-distrib/raw/main/latest.zip"
          Invoke-WebRequest -Uri $url -OutFile "dalamud.zip"
          Expand-Archive -Force "dalamud.zip" $dalamudPath

          $dalamudDll = Join-Path $dalamudPath "Dalamud.dll"
          if (-not (Test-Path $dalamudDll)) {
            Write-Error "Dalamud.dll not found after download"
            exit 1
          }

      - name: Restore
        run: dotnet restore

      - name: Build Release
        run: dotnet build SocialMorpho.csproj -c Release --no-restore

      - name: Create latest.zip
        shell: pwsh
        run: |
          $outputDir = "bin/Release/net10.0-windows"
          $releaseDir = "release"
          Remove-Item -Recurse -Force $releaseDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $releaseDir | Out-Null

          $required = @(
            "$outputDir/SocialMorpho.dll",
            "$outputDir/SocialMorpho.json"
          )

          foreach ($file in $required) {
            if (-not (Test-Path $file)) {
              Write-Error "Missing required build output: $file"
              exit 1
            }
            Copy-Item $file -Destination $releaseDir
          }

          if (Test-Path "Resources/quest_icon.png") {
            New-Item -ItemType Directory -Force -Path "$releaseDir/Resources" | Out-Null
            Copy-Item "Resources/quest_icon.png" -Destination "$releaseDir/Resources/quest_icon.png"
          }

          $popupImages = @("aCmbspI.png", "Square.png", "LoveQuest.png")
          foreach ($img in $popupImages) {
            $src = "Resources/$img"
            if (Test-Path $src) {
              New-Item -ItemType Directory -Force -Path "$releaseDir/Resources" | Out-Null
              Copy-Item $src -Destination "$releaseDir/Resources/$img"
            }
          }


          if (Test-Path "$outputDir/Quests.json") {
            Copy-Item "$outputDir/Quests.json" -Destination $releaseDir
          }

          Compress-Archive -Path "$releaseDir/*" -DestinationPath "latest.zip" -Force
          Get-ChildItem latest.zip | Format-List Name,Length

      - name: Validate latest.zip contents
        shell: pwsh
        run: |
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          $zipPath = (Resolve-Path "latest.zip").Path
          $zip = [System.IO.Compression.ZipFile]::OpenRead($zipPath)
          try {
            $entries = @($zip.Entries | ForEach-Object { $_.FullName })
            $required = @("SocialMorpho.dll", "SocialMorpho.json", "Resources/quest_icon.png", "Resources/aCmbspI.png", "Resources/Square.png")

            foreach ($file in $required) {
              if ($entries -notcontains $file) {
                Write-Error "Invalid latest.zip: missing root entry '$file'. Entries: $($entries -join ', ')"
                exit 1
              }
            }

            if ($entries -contains "latest.zip") {
              Write-Error "Invalid latest.zip: found nested latest.zip entry."
              exit 1
            }
          } finally {
            $zip.Dispose()
          }

      - name: Upload latest.zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: latest-zip
          path: latest.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          persist-credentials: true

      - name: Download latest.zip artifact
        uses: actions/download-artifact@v4
        with:
          name: latest-zip
          path: .

      - name: Compute next auto version
        id: version
        shell: bash
        run: |
          BASE_VERSION=$(grep -oP '<Version>\K[^<]+' SocialMorpho.csproj)
          IFS='.' read -r MAJOR MINOR PATCH EXTRA <<< "$BASE_VERSION"
          if [ -z "$MAJOR" ] || [ -z "$MINOR" ]; then
            echo "Invalid <Version> in SocialMorpho.csproj: $BASE_VERSION"
            exit 1
          fi
          PATCH=${PATCH:-0}

          LATEST_PATCH=$(git tag -l "v${MAJOR}.${MINOR}.*" \
            | sed -E "s/^v${MAJOR}\\.${MINOR}\\.([0-9]+)$/\\1/" \
            | awk '/^[0-9]+$/' \
            | sort -n \
            | tail -n1)

          if [ -z "$LATEST_PATCH" ]; then
            NEXT_PATCH=$PATCH
          else
            NEXT_PATCH=$((LATEST_PATCH + 1))
          fi

          VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Auto version: ${VERSION}"
          cp latest.zip "SocialMorpho-v${VERSION}.zip"

      - name: Validate downloaded latest.zip
        shell: bash
        run: |
          unzip -l latest.zip
          unzip -Z1 latest.zip | grep -qx "SocialMorpho.dll"
          unzip -Z1 latest.zip | grep -qx "SocialMorpho.json"
          unzip -Z1 latest.zip | grep -qx "Resources/quest_icon.png"
          unzip -Z1 latest.zip | grep -qx "Resources/aCmbspI.png"
          unzip -Z1 latest.zip | grep -qx "Resources/Square.png"
          if unzip -Z1 latest.zip | grep -qx "latest.zip"; then
            echo "Invalid latest.zip: nested latest.zip found"
            exit 1
          fi

      - name: Publish versioned release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          target_commitish: ${{ github.sha }}
          body: |
            Automated release from `${{ github.ref_name }}`.
            Commit: `${{ github.sha }}`
          files: SocialMorpho-v${{ steps.version.outputs.version }}.zip
          overwrite_files: true
          fail_on_unmatched_files: true
          make_latest: true
          draft: false
          prerelease: false

      - name: Publish or update latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          target_commitish: ${{ github.sha }}
          body: |
            Automated release from `${{ github.ref_name }}`.
            Commit: `${{ github.sha }}`
          files: latest.zip
          overwrite_files: true
          fail_on_unmatched_files: true
          make_latest: true
          draft: false
          prerelease: false


